<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ªç‰©å½ˆç æŠ½è›‹çµ±è¨ˆå·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <!-- å‹•æ…‹èƒŒæ™¯ -->
    <div class="bg-decoration"></div>

    <div class="container main-container">
        <header class="app-header text-center">
            <div class="icon-badge mx-auto mb-3">ğŸ“Š</div>
            <h1>æ€ªç‰©å½ˆç æŠ½è›‹çµ±è¨ˆ</h1>
            
            <!-- æ–°å¢ï¼šé›²ç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ (ä»¿ç…§æœå¯¦åˆ†é…å·¥å…·) -->
            <div id="cloudStatus" class="cloud-status" style="display: none;">
                <span class="status-dot"></span>
                <span id="cloudStatusText">é€£ç·šä¸­...</span>
            </div>

            <!-- Google ç™»å…¥å€å¡Š -->
            <div id="auth-container" class="mt-2">
                <button type="button" id="google-login-btn" class="auth-btn login" style="display: none;">
                    <i class="bi bi-google"></i> ç™»å…¥ Google å¸³è™Ÿä»¥å•Ÿç”¨é›²ç«¯åŠŸèƒ½
                </button>
                
                <div id="user-info" style="display: none;">
                    <img id="user-avatar" src="" alt="User" class="rounded-circle me-2" style="width: 30px; height: 30px;">
                    <span id="user-display-name" class="me-3 fw-bold"></span>
                    <button type="button" id="logout-btn" class="auth-btn logout btn btn-sm btn-outline-secondary">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <!-- 1. è³‡æ–™è¼¸å…¥è¡¨å–® -->
        <div class="section-card">
            <div class="card-header">
                <h2><i class="bi bi-pencil-square"></i> ç´€éŒ„ç·¨è¼¯</h2>
            </div>
            <form id="gacha-form" class="p-3">
                <!-- å°‡æ‰€æœ‰æ¬„ä½åŒ…è£¹åœ¨ fieldset ä¸­ï¼Œé è¨­ç¦ç”¨ -->
                <fieldset id="gacha-fieldset" class="row g-3" disabled>
                    <div class="col-md-3">
                        <label for="date" class="form-label">æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                    <!-- Event æ¬„ä½ -->
                    <div class="col-md-6" id="event-field-container">
                        <label for="event-select" class="form-label">æ´»å‹•åç¨±</label>
                        <div class="input-group">
                            <select id="event-select" class="form-select">
                                <!-- é¸é …æœƒç”± JS å‹•æ…‹è¼‰å…¥ -->
                            </select>
                            <button type="button" class="btn btn-subtle" id="edit-event-btn" style="display: none;" title="ç·¨è¼¯æ­¤æ´»å‹•"><i class="bi bi-pencil-square"></i></button>
                        </div>
                        <div id="event-input-group" style="display: none;">
                            <input type="text" id="event-input" class="form-control" placeholder="è¼¸å…¥æ–°æ´»å‹•åç¨±">
                            <button type="button" id="cancel-new-event" class="btn btn-link btn-sm p-0 mt-1">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="tag-select" class="form-label">æ¨™ç±¤</label>
                        <select id="tag-select" class="form-select">
                            <option value="none" selected>-- é¸æ“‡æ¨™ç±¤ --</option>
                            <option value="honke">æœ¬å®¶</option>
                            <option value="collab">åˆä½œ</option>
                            <option value="free">å…è²»</option>
                            <option value="orb">å¯¶ç </option>
                        </select>
                    </div>
                    <div class="col-md-3" id="account-field-container">
                        <label for="account-select" class="form-label">å¸³è™Ÿ</label>
                        <div class="input-group">
                            <select id="account-select" class="form-select">
                                <!-- é¸é …æœƒç”± JS å‹•æ…‹è¼‰å…¥ -->
                            </select>
                            <button type="button" class="btn btn-subtle" id="edit-account-btn" title="æ–°å¢/ç·¨è¼¯å¸³è™Ÿ"><i class="bi bi-pencil-square"></i></button>
                        </div>
                        <div id="account-input-group" style="display: none;">
                            <input type="text" id="account-input" class="form-control" placeholder="è¼¸å…¥æ–°å¸³è™Ÿåç¨±">
                            <button type="button" id="cancel-new-account" class="btn btn-link btn-sm p-0 mt-1">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="pulls" class="form-label">æŠ•å…¥æŠ½æ•¸</label>
                        <input type="number" class="form-control" id="pulls" min="0" required placeholder="ä¾‹å¦‚: 90">
                    </div>
                    <div class="col-md-6">
                        <label for="notes" class="form-label">ç²å¾—è§’è‰²</label>
                        <input type="text" class="form-control" id="notes" placeholder="ä¾‹å¦‚ï¼šè™¹å¤*3, éº’éºŸå…’*2 (æŠ½æ•¸æœƒè‡ªå‹•ç§»é™¤)">
                    </div>
                </fieldset>
                
                <!-- æŒ‰éˆ•åˆ—ç¨ç«‹æ–¼ fieldset ä¹‹å¤– -->
                <div class="row mt-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <div> <!-- å„²å­˜/å–æ¶ˆæŒ‰éˆ• (å·¦å´) -->
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> <span id="submit-btn-text">å„²å­˜ç´€éŒ„</span></button>
                            <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;"><i class="bi bi-x-circle"></i> å–æ¶ˆç·¨è¼¯</button>
                        </div>
                        <div> <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• (å³å´) -->
                            <button type="button" class="btn btn-outline-secondary" id="mode-toggle-btn" title="åˆ‡æ›æª¢è¦–/ç·¨è¼¯æ¨¡å¼">
                                <i class="bi bi-eye"></i> 
                                <span id="mode-toggle-text">æª¢è¦–æ¨¡å¼ (é»æ­¤ç·¨è¼¯)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- 2. çµ±è¨ˆå„€è¡¨æ¿ -->
        <div class="section-card mt-4">
            <div class="card-header">
                <h2><i class="bi bi-bar-chart-line-fill"></i> çµ±è¨ˆå„€è¡¨æ¿</h2>
            </div>
            <div id="stats-dashboard" class="p-2">
                <!-- å¡ç‰‡1: ç¯©é¸å™¨ & ç¸½æŠ½æ•¸ -->
                <div class="stat-card filter-card">
                    <h5 id="filter-title"><i class="bi bi-filter"></i> ç¯©é¸</h5>
                    
                    <label for="account-filter" class="form-label stat-filter-label">å¸³è™Ÿ</label>
                    <select id="account-filter" class="form-select mb-2">
                        <option value="all">å…¨éƒ¨å¸³è™Ÿ</option>
                    </select>

                    <label for="year-filter" class="form-label stat-filter-label">å¹´ä»½</label>
                    <select id="year-filter" class="form-select mb-2">
                        <option value="all">å…¨éƒ¨å¹´ä»½</option>
                    </select>

                    <label for="month-filter" class="form-label stat-filter-label">æœˆä»½</label>
                    <select id="month-filter" class="form-select mb-3" disabled>
                        <option value="all">å…¨éƒ¨æœˆä»½</option>
                    </select>
                    
                    <h5 id="total-pulls-title" class="mt-3"><i class="bi bi-gem"></i> ç¸½æŠ•å…¥æŠ½æ•¸</h5>
                    <h3 id="total-pulls">0</h3>
                </div>
                <!-- å¡ç‰‡2: å„å¸³è™ŸæŠ½æ•¸ -->
                <div class="stat-card" id="account-stats">
                    <h5><i class="bi bi-people-fill"></i> å„å¸³è™Ÿç¸½æŠ½æ•¸</h5>
                </div>
                <!-- å¡ç‰‡3: å„æ´»å‹•æŠ½æ•¸ (å¯æ»¾å‹•) -->
                <div class="stat-card" id="event-stats">
                    <h5><i class="bi bi-calendar-event-fill"></i> å„æ´»å‹•ç¸½æŠ½æ•¸</h5>
                </div>
            </div>
        </div>

        <!-- 3. æ­·å²ç´€éŒ„è¡¨æ ¼ -->
        <div class="section-card mt-4">
            <div class="card-header">
                <h2 id="history-table-title"><i class="bi bi-table"></i> æ­·å²ç´€éŒ„ (Tidy Data)</h2>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ´»å‹•</th>
                            <th>å¸³è™Ÿ</th>
                            <th>æŠ½æ•¸</th>
                            <th>ç²å¾—è§’è‰²</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 4. è³‡æ–™ç®¡ç† -->
        <div class="section-card mt-4 mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-database-fill-gear"></i> è³‡æ–™ç®¡ç†</h2>
                <span id="admin-badge" class="badge bg-danger" style="display: none;">ç®¡ç†å“¡æ¨¡å¼</span>
            </div>
            <div class="p-2">
                <div class="btn-group w-100 flex-wrap">
                    <!-- ä¸€èˆ¬åŠŸèƒ½ -->
                    <button id="export-data" class="btn btn-success custom-btn m-1" title="å„²å­˜ç›®å‰ç´€éŒ„ç‚º JSON æª”æ¡ˆ"><i class="bi bi-save"></i> å„²å­˜è³‡æ–™</button>
                    <button id="import-data" class="btn btn-info custom-btn m-1 text-white" title="è¼‰å…¥ JSON æª”æ¡ˆæˆ–ç®¡ç†å“¡é‡‘é‘°"><i class="bi bi-folder2-open"></i> è¼‰å…¥è³‡æ–™</button>
                    <button id="sync-remote-events" class="btn btn-primary custom-btn m-1"><i class="bi bi-cloud-download"></i> åŒæ­¥å®˜æ–¹æ´»å‹•</button>
                    <button id="clear-data" class="btn btn-danger custom-btn m-1"><i class="bi bi-trash3"></i> åˆå§‹åŒ–è³‡æ–™</button>
                    
                    <!-- ç®¡ç†å“¡åŠŸèƒ½ (é è¨­éš±è—) -->
                    <button id="export-event-json" class="btn btn-secondary custom-btn m-1 admin-only"><i class="bi bi-card-list"></i> åŒ¯å‡ºæ´»å‹• JSON</button>
                    <button id="import-events-file-btn" class="btn btn-secondary custom-btn m-1 admin-only"><i class="bi bi-file-earmark-arrow-up"></i> åŒ¯å…¥æ´»å‹•æª”æ¡ˆ</button>
                </div>
                
                <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥æ¡† -->
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <input type="file" id="import-events-file-input" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <!-- æ‡¸æµ®å·¥å…·ç®±èœå–® -->
    <div class="toolbox-menu-wrapper" title="æ»‘é¼ æ‡¸åœä»¥å±•é–‹èœå–®">
        <div class="toolbox-items-list">
            <a href="https://emily4027.github.io/monster-strike-toolbox/" class="toolbox-item">
                <i class="bi bi-house-fill"></i> å·¥å…·ç®±é¦–é 
            </a>
            <a href="https://emily4027.github.io/monster-strike-fruit-assign/" class="toolbox-item">
                <i class="bi bi-apple"></i> æœå¯¦åˆ†é…æ¨¡æ“¬
            </a>
            <a href="https://emily4027.github.io/monster-strike-gacha/" class="toolbox-item active">
                <i class="bi bi-bar-chart-line-fill"></i> æŠ½å¡çµ±è¨ˆ (ç¾è¡Œ)
            </a>
        </div>
        <button type="button" class="toolbox-main-btn">
            <i class="bi bi-tools"></i> å·¥å…·ç®±
        </button>
    </div>

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="toast-message"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjpfcNC4ZniqIxYzgYwp5Cs_8gbbmflVY",
            authDomain: "ms-toolbox-web.firebaseapp.com",
            projectId: "ms-toolbox-web",
            storageBucket: "ms-toolbox-web.firebasestorage.app",
            messagingSenderId: "777818785736",
            appId: "1:777818785736:web:880b878f4a510132dfe2fd",
            measurementId: "G-7KV0FSL1RG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // å°‡ Firebase ç‰©ä»¶æ›è¼‰åˆ° window ä»¥ä¾¿ script.js ä½¿ç”¨
        window.firebaseAuth = auth;
        window.db = db;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp;
    </script>

    <!-- å¼•å…¥ JavaScript æª”æ¡ˆ -->
    <script src="script.js" defer></script>
</body>

</html>
