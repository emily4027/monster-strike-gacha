<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>怪物彈珠抽蛋統計工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <!-- 動態背景 -->
    <div class="bg-decoration"></div>

    <div class="container main-container">
        <header class="app-header text-center">
            <div class="icon-badge mx-auto mb-3">📊</div>
            <h1>怪物彈珠抽蛋統計工具</h1>
            
            <!-- 雲端狀態指示器 -->
            <div id="cloudStatus" class="cloud-status" style="display: none;">
                <span class="status-dot"></span>
                <span id="cloudStatusText">連線中...</span>
            </div>
            
            <!-- 認證錯誤訊息顯示區 -->
            <div id="authErrorMsg" style="display: none; color: #b92b27; font-size: 12px; text-align: center; margin-bottom: 10px; padding: 5px; background: #ffe6e6; border-radius: 4px;"></div>

            <!-- Google 登入區塊 -->
            <div id="auth-container" class="mt-2">
                <button type="button" id="google-login-btn" class="auth-btn login" style="display: none;">
                    <i class="bi bi-google"></i> 登入 Google 帳號以啟用雲端功能
                </button>
                
                <div id="user-info" style="display: none;">
                    <img id="user-avatar" src="" alt="User" class="rounded-circle me-2" style="width: 30px; height: 30px;">
                    <span id="user-display-name" class="me-3 fw-bold"></span>
                    <button type="button" id="logout-btn" class="auth-btn logout btn btn-sm btn-outline-secondary">登出</button>
                </div>
            </div>
        </header>

        <!-- 1. 資料輸入表單 -->
        <div class="section-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-pencil-square"></i> 紀錄編輯</h2>
                <!-- 新增：右上角教學按鈕 -->
                <button type="button" class="btn btn-info btn-sm text-white" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-circle-fill"></i> 格式教學與範例
                </button>
            </div>
            <form id="gacha-form" class="p-3">
                <!-- 將所有欄位包裹在 fieldset 中，預設禁用 -->
                <fieldset id="gacha-fieldset" class="row g-3" disabled>
                    <div class="col-md-3">
                        <label for="date" class="form-label">日期</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                    <!-- Event 欄位 -->
                    <div class="col-md-6" id="event-field-container">
                        <label for="event-select" class="form-label">活動名稱</label>
                        <div class="input-group">
                            <select id="event-select" class="form-select">
                                <!-- 選項會由 JS 動態載入 -->
                            </select>
                            <button type="button" class="btn btn-subtle" id="edit-event-btn" style="display: none;" title="編輯此活動"><i class="bi bi-pencil-square"></i></button>
                        </div>
                        <div id="event-input-group" style="display: none;">
                            <input type="text" id="event-input" class="form-control" placeholder="輸入新活動名稱">
                            <button type="button" id="cancel-new-event" class="btn btn-link btn-sm p-0 mt-1">取消</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="tag-select" class="form-label">標籤</label>
                        <select id="tag-select" class="form-select">
                            <option value="none" selected>-- 選擇標籤 --</option>
                            <option value="honke">本家</option>
                            <option value="collab">合作</option>
                            <option value="free">免費</option>
                            <option value="orb">寶珠</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="account-field-container">
                        <label for="account-select" class="form-label">帳號</label>
                        <div class="input-group">
                            <select id="account-select" class="form-select">
                                <!-- 選項會由 JS 動態載入 -->
                            </select>
                            <button type="button" class="btn btn-subtle" id="edit-account-btn" title="新增/編輯帳號"><i class="bi bi-pencil-square"></i></button>
                        </div>
                        <div id="account-input-group" style="display: none;">
                            <input type="text" id="account-input" class="form-control" placeholder="輸入新帳號名稱">
                            <button type="button" id="cancel-new-account" class="btn btn-link btn-sm p-0 mt-1">取消</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="pulls" class="form-label">投入抽數</label>
                        <input type="number" class="form-control" id="pulls" min="0" required placeholder="例如: 90">
                    </div>
                    <div class="col-md-6">
                        <label for="notes" class="form-label">獲得角色</label>
                        <input type="text" class="form-control" id="notes" placeholder="例如：虹夏*3, 麒麟兒*2">
                        <div class="form-text mt-1" style="font-size: 0.85rem; color: #6c757d;">
                            <i class="bi bi-magic"></i> 系統會自動將輸入標準化 (例: 亞森x2 尼奧 -> 亞森*2、尼奧)
                        </div>
                    </div>
                </fieldset>
                
                <!-- 按鈕列獨立於 fieldset 之外 -->
                <div class="row mt-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <div> <!-- 儲存/取消按鈕 (左側) -->
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> <span id="submit-btn-text">儲存紀錄</span></button>
                            <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="display: none;"><i class="bi bi-x-circle"></i> 取消編輯</button>
                        </div>
                        <div> <!-- 模式切換按鈕 (右側) -->
                            <button type="button" class="btn btn-outline-secondary" id="mode-toggle-btn" title="切換檢視/編輯模式">
                                <i class="bi bi-eye"></i> 
                                <span id="mode-toggle-text">檢視模式 (點此編輯)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- 2. 統計儀表板 -->
        <div class="section-card mt-4">
            <div class="card-header">
                <h2><i class="bi bi-bar-chart-line-fill"></i> 統計儀表板</h2>
            </div>
            <div id="stats-dashboard" class="p-2">
                <!-- 卡片1: 篩選器 & 總抽數 -->
                <div class="stat-card filter-card">
                    <h5 id="filter-title"><i class="bi bi-filter"></i> 篩選條件</h5>
                    
                    <!-- 帳號篩選 -->
                    <label for="account-filter" class="form-label stat-filter-label">帳號</label>
                    <select id="account-filter" class="form-select mb-3">
                        <option value="all">全部帳號</option>
                    </select>

                    <!-- 日期篩選 (合併年份與月份) -->
                    <label for="date-filter" class="form-label stat-filter-label">日期範圍</label>
                    <select id="date-filter" class="form-select mb-3">
                        <option value="all">全部日期</option>
                        <!-- JS 動態填入: 2024年, 2024-01, ... -->
                    </select>

                    <!-- 標籤多選篩選 -->
                    <label class="form-label stat-filter-label d-block">活動類型 (可多選)</label>
                    <div class="btn-group w-100 mb-3" role="group" id="tag-filter-group">
                        <input type="checkbox" class="btn-check tag-filter" id="tag-filter-honke" value="honke" autocomplete="off">
                        <label class="btn btn-outline-danger btn-sm" for="tag-filter-honke">本家</label>

                        <input type="checkbox" class="btn-check tag-filter" id="tag-filter-collab" value="collab" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="tag-filter-collab" style="--bs-btn-color: #6610f2; --bs-btn-border-color: #6610f2; --bs-btn-hover-bg: #6610f2; --bs-btn-hover-border-color: #6610f2; --bs-btn-active-bg: #6610f2; --bs-btn-active-border-color: #6610f2;">合作</label>

                        <input type="checkbox" class="btn-check tag-filter" id="tag-filter-free" value="free" autocomplete="off">
                        <label class="btn btn-outline-success btn-sm" for="tag-filter-free">免費</label>

                        <input type="checkbox" class="btn-check tag-filter" id="tag-filter-orb" value="orb" autocomplete="off">
                        <label class="btn btn-outline-warning btn-sm" for="tag-filter-orb">寶珠</label>
                    </div>
                    
                    <h5 id="total-pulls-title" class="mt-3 border-top pt-3"><i class="bi bi-gem"></i> 總投入抽數</h5>
                    <h3 id="total-pulls">0</h3>
                </div>
                <!-- 卡片2: 各帳號抽數 -->
                <div class="stat-card" id="account-stats">
                    <h5><i class="bi bi-people-fill"></i> 各帳號總抽數</h5>
                </div>
                <!-- 卡片3: 各活動抽數 (可滾動) -->
                <div class="stat-card" id="event-stats">
                    <h5><i class="bi bi-calendar-event-fill"></i> 各活動總抽數</h5>
                </div>
            </div>
        </div>

        <!-- 3. 歷史紀錄表格 -->
        <div class="section-card mt-4">
            <div class="card-header">
                <h2 id="history-table-title"><i class="bi bi-table"></i> 歷史紀錄 (Tidy Data)</h2>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>日期</th>
                            <th>活動</th>
                            <th>帳號</th>
                            <th>抽數</th>
                            <th>獲得角色</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 4. 資料管理 -->
        <div class="section-card mt-4 mb-5">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-database-fill-gear"></i> 資料管理</h2>
                <span id="admin-badge" class="badge bg-danger" style="display: none;">管理員模式</span>
            </div>
            <div class="p-2">
                <div class="btn-group w-100 flex-wrap">
                    <!-- 一般功能 -->
                    <button id="export-data" class="btn btn-success custom-btn m-1" title="儲存目前紀錄為 JSON 檔案"><i class="bi bi-save"></i> 儲存資料</button>
                    <button id="import-data" class="btn btn-info custom-btn m-1 text-white" title="載入 JSON 檔案或管理員金鑰"><i class="bi bi-folder2-open"></i> 載入資料</button>
                    <button id="sync-remote-events" class="btn btn-primary custom-btn m-1"><i class="bi bi-cloud-download"></i> 同步官方活動</button>
                    <button id="clear-data" class="btn btn-danger custom-btn m-1"><i class="bi bi-trash3"></i> 初始化資料</button>
                    
                    <!-- 管理員功能 (預設隱藏) -->
                    <button id="export-event-json" class="btn btn-secondary custom-btn m-1 admin-only" title="匯出單一活動模板"><i class="bi bi-card-list"></i> 匯出單一活動</button>
                    <button id="export-all-events-btn" class="btn btn-warning custom-btn m-1 admin-only" title="匯出完整的 events.json"><i class="bi bi-list-stars"></i> 匯出完整清單</button>
                    <button id="import-events-file-btn" class="btn btn-secondary custom-btn m-1 admin-only" title="匯入本地 events.json"><i class="bi bi-file-earmark-arrow-up"></i> 匯入活動檔案</button>
                </div>
                
                <!-- 隱藏的檔案輸入框 -->
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <input type="file" id="import-events-file-input" accept=".json" style="display: none;">
            </div>
        </div>
    </div>

    <!-- 懸浮工具箱菜單 -->
    <div class="toolbox-menu-wrapper" title="滑鼠懸停以展開菜單">
        <div class="toolbox-items-list">
            <a href="https://emily4027.github.io/monster-strike-toolbox/" class="toolbox-item">
                <i class="bi bi-house-fill"></i> 工具箱首頁
            </a>
            <a href="https://emily4027.github.io/monster-strike-fruit-assign/" class="toolbox-item">
                <i class="bi bi-apple"></i> 果實分配模擬
            </a>
            <a href="https://emily4027.github.io/monster-strike-gacha/" class="toolbox-item active">
                <i class="bi bi-bar-chart-line-fill"></i> 抽卡統計 (現行)
            </a>
        </div>
        <button type="button" class="toolbox-main-btn">
            <i class="bi bi-tools"></i> 工具箱
        </button>
    </div>

    <!-- 新增：左下角 GitHub 專案連結 -->
    <a href="https://github.com/emily4027/monster-strike-gacha" target="_blank" class="github-project-link" title="前往 GitHub 專案頁面">
        <i class="bi bi-github"></i> GitHub
    </a>

    <!-- 訊息提示框 -->
    <div id="toast-message"></div>

    <!-- Modal: 輸入說明 -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-info-circle-fill text-primary"></i> 格式教學與範例</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>輸入角色時，您可以使用逗號、頓號或空格來分隔。系統會在儲存時自動幫您排版！</p>
            
            <h6 class="fw-bold mt-3 text-success"><i class="bi bi-check-circle-fill"></i> 正確格式範例 (會被自動轉換)</h6>
            <ul class="list-group list-group-flush mb-3">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>標準格式</span>
                <code>亞森*2、尼奧*1</code>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>隨意輸入 (自動修正)</span>
                <code>亞森x2 尼奧1體/隻</code>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>寶珠標籤</span>
                <code>114 (自動變 114顆)</code>
              </li>
            </ul>

            <h6 class="fw-bold mt-3 text-danger"><i class="bi bi-x-circle-fill"></i> 自動轉換失敗範例</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">錯誤：</span>
                    <code>5亞森 或 亞森5</code>
                </div>
                <small class="text-muted d-block mt-1">原因：數字直接加上名稱時，會被視為當前角色名稱的一部份。</small>
                <small class="text-primary d-block">修正：應輸入為 <code>亞森5體/隻</code> 或 <code>5*亞森 或 <code>亞森*5</code></small>
              </li>
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">錯誤：</span>
                    <code>亞森 14 或 14體 亞森 </code>
                </div>
                <small class="text-muted d-block mt-1">原因：數量和名稱之間有空格時，會被視為新的角色。</small>
                <small class="text-primary d-block">修正：應輸入為 <code>亞森*14</code> 或 <code>14體/隻亞森</code></small>
              </li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">我瞭解了</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjpfcNC4ZniqIxYzgYwp5Cs_8gbbmflVY",
            authDomain: "ms-toolbox-web.firebaseapp.com",
            projectId: "ms-toolbox-web",
            storageBucket: "ms-toolbox-web.firebasestorage.app",
            messagingSenderId: "777818785736",
            appId: "1:777818785736:web:880b878f4a510132dfe2fd",
            measurementId: "G-7KV0FSL1RG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.db = db;
        window.envAppId = appId;
        
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithCustomToken = signInWithCustomToken;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp;

        const initAuth = async () => {
          const errorDiv = document.getElementById('authErrorMsg');
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
              await signInWithCustomToken(auth, __initial_auth_token);
            } catch (e) {
              console.error("Custom token login failed:", e);
              if (errorDiv) {
                  const errorCode = e.code || "unknown error";
                  errorDiv.style.display = 'block';
                  errorDiv.innerHTML = `<strong>❌ 登入失敗：</strong> 雲端連線被拒絕 (${errorCode})<br>請重新登入工具箱主站，或檢查 Firebase 專案設定。`;
              }
            }
          } else {
             console.log("No auth token provided, remaining offline.");
          }
        };
        initAuth();
    </script>

    <!-- 引入 JavaScript 檔案 -->
    <script src="script.js" defer></script>
    <!-- 引入 Bootstrap JS (for Modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>